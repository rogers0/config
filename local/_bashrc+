
alias auu='apt-get update && apt-get upgrade --no-install-recommends && apt-get autoremove && apt-get clean'
alias wlan='export WLAN=$(find /sys/class/net -follow -maxdepth 2 -name phy80211 2>/dev/null|cut -d/ -f5)'
alias iwlist='wlan; sudo iwlist $WLAN scan|grep ESSID'
alias iwinfo='wlan; sudo iwlist $WLAN scan|less -p ESSID'
alias iwlist2='wlan; sudo iw $WLAN scan|grep SSID'
alias iwinfo2='wlan; sudo iw $WLAN scan|less -p SSID'
alias netconsole_ip='ip a add 192.168.11.1/24 dev eth0'
alias check.ext4='fsck.ext4 -pDftt'
alias zoom='flatpak run us.zoom.Zoom'

alias serial='screen /dev/ttyUSB0 115200'
alias du='du -h --max-depth=1'
alias rsyncplain='rsync -rltDPv'
alias netconsole='nc -l -u -p 6666 | tee ~/netconsole.log' # netconsole will send to 192.168.1.100:6666 # ip a add 192.168.1.100/24 dev eth0
alias 7='7z a -t7z -m0=lzma -mx=9 -mfb=64 -md=32m'
alias 7cp='7z a -t7z -mx0'
alias 7secret='7z a -t7z -m0=lzma -mx=9 -mfb=64 -md=32m -p -mhe'

alias dquilt="quilt --quiltrc=${HOME}/.quiltrc-dpkg"
alias reapply='dquilt pop -a; while dquilt push; do dquilt refresh; done'
complete -F _quilt_completion $_quilt_complete_opt dquilt

JOBS=$(($(nproc)*2-1))
debian_oldstable_version=9
debian_stable_version=10
debian_oldstable=stretch
debian_stable=buster

alias amendcommit="GIT_COMMITTER_DATE=\$(git show --pretty=fuller|sed -n '5{p;q}'|cut -d: -f2-) git commit --amend --no-edit"
alias amendmerge="GIT_COMMITTER_DATE=\$(git show --pretty=fuller|sed -n '4{p;q}'|cut -d: -f2-) git commit --amend --no-edit"
alias amendreset="GIT_COMMITTER_DATE=\$(git show --pretty=fuller|sed -n '3{p;q}'|cut -d: -f2-) git commit --amend --no-edit"
alias resetgit='git clean -fdx; git reset --hard'
alias resetrepo='repo --time forall -vc "git clean -fdxq; git reset --hard -q"'
alias reposync='repo --time sync -q -c -d -j$JOBS'
alias reposyncnet='repo --time sync -q -c -n -j$JOBS'
alias reposynclocal='repo --time sync -q -d -l -j$JOBS'
alias gitmp='find . -name tmp_pack_\*'
alias gbpnew='gbp buildpackage -us -uc --git-ignore-branch --git-compression=xz'
alias gbpp='gbp buildpackage -us -uc --git-ignore-branch --git-pristine-tar'
alias gpb='gbp buildpackage --git-ignore-branch --git-pristine-tar --git-pbuilder'
alias gpbupdate='git-pbuilder update --override-config'

alias getkey='gpg --recv-keys 0x6C6ACD6417B3ACB1 --keyserver keyring.debian.org'
alias debemail='export DEBEMAIL=$(git config user.email)'
alias dch-r='debemail; dch -r ""; git add debian/changelog; git commit -m "Prepare to release $(dpkg-parsechangelog -SVersion)"; gitag'
alias gitag='git tag debian/$(dpkg-parsechangelog -SVersion|sed "s/~/_/g;s/:/%/g") HEAD; git show-branch debian/$(dpkg-parsechangelog -SVersion|sed "s/~/_/g;s/:/%/g") HEAD'
alias deps='mk-build-deps --root-cmd sudo --install --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends"'
alias depsbpo='mk-build-deps --root-cmd sudo --install --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -t ${debian_stable}-backports"'
alias depsoldbpo='mk-build-deps --root-cmd sudo --install --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -t ${debian_oldstable}-backports"'
alias bpostable='debemail; dch --bpo -D ${debian_stable}-backports ""; git add debian/changelog; git commit -m "Rebuild as $(dpkg-parsechangelog -SVersion) for ${debian_stable}-backports"; gitag'
alias bposloppy='debemail; dch --no-auto-nmu -D ${debian_oldstable}-backports-sloppy "Rebuild for ${debian_oldstable}-backports-sloppy."; sed -i "1 s/~bpo${debian_stable_version}+2/~bpo${debian_oldstable_version}+1/" debian/changelog; git add debian/changelog; git commit -m "Rebuild as $(dpkg-parsechangelog -SVersion) for ${debian_oldstable}-backports-sloppy"; gitag'
alias bpoldstable='debemail; dch --bpo --no-auto-nmu -D ${debian_oldstable}-backports "Rebuild for ${debian_oldstable}-backports."; sed -i "1 s/~bpo${debian_stable_version}+1/~bpo${debian_oldstable_version}+1/" debian/changelog; git add debian/changelog; git commit -m "Rebuild as $(dpkg-parsechangelog -SVersion) for ${debian_oldstable}-backports"; gitag'
alias bpostableteam='debemail; dch --bpo -D ${debian_stable}-backports "Team upload."; git add debian/changelog; git commit -m "Rebuild as $(dpkg-parsechangelog -SVersion) for ${debian_stable}-backports"; gitag'
alias bposloppyteam='debemail; dch --team -D ${debian_oldstable}-backports-sloppy "Rebuild for ${debian_oldstable}-backports-sloppy."; sed -i "1 s/~bpo${debian_stable_version}+2/~bpo${debian_oldstable_version}+1/" debian/changelog; git add debian/changelog; git commit -m "Rebuild as $(dpkg-parsechangelog -SVersion) for ${debian_oldstable}-backports-sloppy"; gitag'
alias dakrminfo='ssh mirror.ftp-master.debian.org "dak rm -Rn $1"'

[ -z "$PATH_ORIG" ] && export PATH_ORIG=$PATH
export PATH=/usr/lib/ccache:$PATH_ORIG:~/bin
export USE_CCACHE=1
export CCACHE_EXEC=$(which ccache)
export CCACHE_CPP2=yes
export CCACHE_COMPILERCHECK=content
#export DEBEMAIL=rogershimizu@gmail.com
export DEBEMAIL=rosh@debian.org
export DEBNAME="Roger Shimizu"
#DEBFULLNAME="Roger Shimizu"
export DEB_BUILD_OPTIONS=parallel=$JOBS
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
export VISUAL=vim
#export http_proxy=
#export no_proxy=
export TZ='Asia/Tokyo'
#export TZ='Europe/Sofia'

export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx

REPO_URL=https://android.googlesource.com/platform/manifest
REPO_MIRROR=/data/mirror
repo-init() {
  echo repo --time init -q -u $REPO_URL -b $1 --reference=$REPO_MIRROR/$1
  repo --time init -q -u $REPO_URL -b $1 --reference=$REPO_MIRROR/$1
  echo repo --time sync -j$JOBS
}
adbserial() {
  while true; do
    case "$(adb devices|grep -w device|wc -l)" in
    0)echo -e No device connected.\\nadb wait-for-device
      ANDROID_SERIAL= adb -s "$1" wait-for-device
      continue ;;
    1)serial=$(adb devices|grep -w device|sed 's/device//g'|sed -e 's/[[:space:]]*$//'|tail -n1)
      DEV_SERIAL=$serial
      [ -n "$ANDROID_SERIAL" ] && DEV_SERIAL="$ANDROID_SERIAL"
      [ -n "$1" ] && DEV_SERIAL="$1"
      break ;;
    *)unset DEV_SERIAL
      [ -n "$ANDROID_SERIAL" ] && DEV_SERIAL="$ANDROID_SERIAL"
      [ -n "$1" ] && DEV_SERIAL="$1"
      [ -z "$DEV_SERIAL" ] && adb devices && return
      break ;;
    esac
  done
  echo adb tries connecting to $DEV_SERIAL
}
adbsomccleanup() {
  adb wait-for-device shell "rm -rf /data/crashd* /mnt/sdcard/Crash*"
}
adbsomcskip() {
  adbserial $1
  while true; do
    case "$(adb -s $DEV_SERIAL shell settings get secure user_setup_complete 2>/dev/null)" in
    0)  adb -s $DEV_SERIAL shell settings put secure user_setup_complete 1
      echo Done: adb shell settings put secure user_setup_complete 1
      break ;;
    1)  break ;;
    *)  echo -n .
      sleep 0.5
      continue ;;
    esac
  done
  adbsomccleanup
  #adb -s $DEV_SERIAL shell setprop persist.sys.usb.testmode mtp
}
adbremount() {
  adbserial $1
  adb -s $DEV_SERIAL wait-for-device root
  sleep 0.3
  if adb -s $DEV_SERIAL wait-for-device remount|grep verity>/dev/null; then
    adb -s $DEV_SERIAL wait-for-device disable-verity
    adb -s $DEV_SERIAL wait-for-device reboot
    adb -s $DEV_SERIAL wait-for-device root
    sleep 0.3
    adb -s $DEV_SERIAL wait-for-device remount
  else
    echo adb remount succeeded
  fi
  adbsomcskip $DEV_SERIAL
}
adbscreen() {
  adbserial $1
  SCREENCAP="Screenshot_${DEV_SERIAL}_$(date +"%Y%m%d-%H%M%S").png"
  adb -s $DEV_SERIAL shell screencap -p > ${SCREENCAP}
  echo ${SCREENCAP}
}
pdebuild() {
  [ -f debian/changelog ] &&
    DIST=$(dpkg-parsechangelog|awk '/^Distribution: / {print $2}')
  [ -z "$DIST" ] &&
    DIST=$(lsb_release --short --codename)
  BASEPATH=/var/cache/pbuilder/base-${DIST}.cow
  [ ! -d $BASEPATH ] &&
    DIST=${DIST}-backports &&
    BASEPATH=/var/cache/pbuilder/base-${DIST}.cow
  if [ -d $BASEPATH ]; then
    echo /usr/bin/pdebuild -- --distribution $DIST --basepath $BASEPATH
    /usr/bin/pdebuild -- --distribution $DIST --basepath $BASEPATH
  else
    echo cowbuilder folder does not exist: $BASEPATH
  fi
  unset DIST BASEPATH
}
adbmmlist() {
  timeout=5
  [ -n "$1" ] && timeout="$1"
  TARGET=$ANDROID_PRODUCT_OUT
  [ -z "$TARGET" ] &&
    printf "\nNot in Android environment.\nPlease run 'source build/envsetup.sh' and 'lunch' command first.\n\n" && return
  find $TARGET/system -type f -cmin -$timeout | while read f; do {
    printf "Update: $(eval "echo ${f##$TARGET}")\n"
  }; done;
  find $TARGET/vendor -type f -cmin -$timeout | while read f; do {
    printf "Update: $(eval "echo ${f##$TARGET}")\n"
  }; done
}
adbmmsync() {
  timeout=5
  [ -n "$1" ] && timeout="$1"
  TARGET=$ANDROID_PRODUCT_OUT
  [ -z "$TARGET" ] &&
    printf "\nNot in Android environment.\nPlease run 'source build/envsetup.sh' and 'lunch' command first.\n\n" && return
  adbremount
  echo

  find $TARGET/system -type f -cmin -$timeout | while read f; do {
    printf "Update: $(eval "echo ${f##$TARGET}")\n"
    adb push "$f" "$(eval "echo ${f##$TARGET}")";
  }; done;
  find $TARGET/vendor -type f -cmin -$timeout | while read f; do {
    printf "Update: $(eval "echo ${f##$TARGET}")\n"
    adb push "$f" "$(eval "echo ${f##$TARGET}")";
  }; done

  # To flush all cache
  adb shell sync
  printf "Restarting Camera!!!\n"
  adb shell kill $(adb shell ps -A | grep camera.provider | awk '{print $2}')
  printf "Clearing logcat!!!\n"
  adb logcat -c
}
